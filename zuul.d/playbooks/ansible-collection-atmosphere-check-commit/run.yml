# Copyright (c) 2022 VEXXHOST, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- hosts: localhost
  gather_facts: false
  vars:
    zuul:
      message: U2VtLVZlcgo=
      project:
        canonical_hostname: opendev.org
        name: vexxhost/ansible-collection-atmosphere
      ref: refs/changes/92/834092/2
  tasks:
    - name: Get the commit for the ref
      uri:
        url: "https://{{ zuul.project.canonical_hostname }}/api/v1/repos/{{ zuul.project.name }}/git/refs/{{ zuul.ref | replace('refs/', '') | urlencode }}"
        return_content: true
      register: _git_ref

    - name: Get the commit details
      uri:
        url: "{{ _git_ref.json[0].object.url }}"
        return_content: true
      register: _git_commit

    - block:
        - name: Run assertions on commit
          assert:
            that: "{{ item.that }}"
            fail_msg: "{{ item.msg }}"
          loop:
            - that: "'Sem-Ver' in (zuul.message | b64decode)"
              msg: "Sem-Ver tag missing from commit message, see: https://docs.openstack.org/pbr/latest/user/features.html#version"
            - that: "(_git_commit.json.files | selectattr('filename', 'search', 'releasenotes/') | list | length) != 0"
              msg: "Missing release note in commit message, please create one using `reno`."
          loop_control:
            label: "{{ item.that }}"
          register: _assertions

      always:
        - name: Generate list of Zuul warnings
          set_fact:
            _warnings: "{{ _assertions.results | selectattr('failed', 'equalto', true) | map(attribute='msg') | list }}"
        - name: Print list of Zuul warnings
          debug:
            msg: "{{_warnings }}"
        - name: Generate a list of Zuul warnings
          zuul_return:
            data:
              zuul:
                warnings: "{{ _warnings }}"