# Copyright (c) 2022 VEXXHOST, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- name: create monitor keyring
  ansible.builtin.shell: |
    ceph-authtool --create-keyring /tmp/ceph.mon.keyring --gen-key -n mon. --cap mon 'allow *'
  args:
    creates: /tmp/ceph.mon.keyring
  when:
    - inventory_hostname == groups[ceph_mon_group][0]

- name: create admin keyring
  ansible.builtin.shell: |
    ceph-authtool --create-keyring /etc/ceph/ceph.client.admin.keyring --gen-key -n client.admin --cap mon 'allow *' --cap osd 'allow *' --cap mds 'allow *' --cap mgr 'allow *'
  args:
    creates: /etc/ceph/ceph.client.admin.keyring
  when:
    - inventory_hostname == groups[ceph_mon_group][0]

- name: create bootstrap-osd keyring
  ansible.builtin.shell: |
    ceph-authtool --create-keyring /var/lib/ceph/bootstrap-osd/ceph.keyring --gen-key -n client.bootstrap-osd --cap mon 'profile bootstrap-osd' --cap mgr 'allow r'
  args:
    creates: /var/lib/ceph/bootstrap-osd/ceph.keyring
  when:
    - inventory_hostname == groups[ceph_mon_group][0]

- name: add admin keyring to monitor
  ansible.builtin.shell: |
    ceph-authtool /tmp/ceph.mon.keyring --import-keyring /etc/ceph/ceph.client.admin.keyring
  when:
    - inventory_hostname == groups[ceph_mon_group][0]

- name: add bootstrap-osd keyring to monitor
  ansible.builtin.shell: |
    ceph-authtool /tmp/ceph.mon.keyring --import-keyring /var/lib/ceph/bootstrap-osd/ceph.keyring
  when:
    - inventory_hostname == groups[ceph_mon_group][0]

- name: create monmap
  ansible.builtin.shell: |
    monmaptool --create --add {{ inventory_hostname_short }} {{ ceph_mon_ip_address }} --fsid {{ ceph_mon_fsid }} /tmp/monmap
  args:
    creates: /tmp/monmap
  when:
    - inventory_hostname == groups[ceph_mon_group][0]

- name: create monitor folder
  ansible.builtin.file:
    path: "/var/lib/ceph/mon/ceph-{{ inventory_hostname_short }}"
    state: directory
  when:
    - inventory_hostname == groups[ceph_mon_group][0]

- name: configure mon initial members
  community.general.ini_file:
    path: /etc/ceph/ceph.conf
    section: global
    option: mon initial members
    value: "{{ inventory_hostname_short }}"

- name: start monitor
  ansible.builtin.include_tasks: start-monitor.yml
  when:
    - inventory_hostname == groups[ceph_mon_group][0]

- name: set bootstrap node
  ansible.builtin.set_fact:
    _ceph_mon_bootstrap_node: "{{ groups[ceph_mon_group][0] }}"
